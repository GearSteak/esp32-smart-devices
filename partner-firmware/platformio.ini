; PlatformIO Project Configuration File
;
; Joystick Partner Device Firmware
; 
; Standalone ESP32 firmware for joystick controller with:
; - Joystick input handling (KY-023)
; - Tilt sensor (SW-520D on GPIO16)
; - USB Serial communication with pi wrist computer
; - Optional LoRa mesh networking (Meshtastic)
;
; BUILD INSTRUCTIONS:
; 1. Install PlatformIO: pip install platformio
; 2. Build: pio run -e translator-partner
; 3. Upload: pio run -e translator-partner -t upload
; 4. Monitor: pio device monitor
;
; See docs/partner-device-meshtastic.md for hardware setup.

[platformio]
default_envs = translator-partner
src_dir = src
include_dir = .

; ============================================================================
; Base ESP32 Configuration
; ============================================================================

[env]
platform = espressif32 @ 6.4.0
framework = arduino

; Common build flags
build_flags = 
    -Wall
    -Wextra
    -D CORE_DEBUG_LEVEL=3
    -D CONFIG_ARDUHAL_LOG_COLORS=1
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1  ; Enable USB Serial on boot

; Common libraries (optional - only if BLE is enabled)
lib_deps = 
    h2zero/NimBLE-Arduino @ ^1.4.0

monitor_speed = 115200
monitor_filters = esp32_exception_decoder, colorize

; ============================================================================
; Translator Partner Device (Joystick Controller)
; ============================================================================

[env:translator-partner]
board = esp32dev
board_build.mcu = esp32
board_build.f_cpu = 240000000L
board_build.f_flash = 80000000L
board_build.flash_mode = dio

; USB Serial enabled
board_build.usb_mode = hardware

; Partition scheme
board_build.partitions = default.csv

build_flags = 
    ${env.build_flags}
    -D TRANSLATOR_PARTNER=1
    -D HAS_JOYSTICK=1
    
    ; USB Serial communication (primary method)
    -D USE_USB_SERIAL=1
    -D USB_SERIAL_BAUD=115200
    
    ; BLE bridge (optional - set to 0 to disable)
    -D HAS_MAIN_DEVICE_BRIDGE=0
    -D BLE_NAME=\"TransPartner\"
    
    ; LoRa configuration (SX1262)
    -D USE_SX1262=1
    -D LORA_SCK=18
    -D LORA_MISO=19
    -D LORA_MOSI=23
    -D LORA_CS=5
    -D SX126X_CS=5
    -D SX126X_DIO1=26
    -D SX126X_BUSY=27
    -D SX126X_RESET=14
    -D SX126X_MAX_POWER=22
    
    ; Joystick configuration (KY-023)
    -D JOYSTICK_X_PIN=34
    -D JOYSTICK_Y_PIN=35
    -D JOYSTICK_BTN_PIN=32
    -D JOYSTICK_CENTER=2048
    -D JOYSTICK_DEADZONE=164
    -D JOYSTICK_SAMPLE_RATE_HZ=100
    -D JOYSTICK_INVERT_X=false
    -D JOYSTICK_INVERT_Y=true
    
    ; Tilt sensor configuration (SW-520D)
    -D HAS_TILT_SENSOR=1
    -D TILT_SENSOR_PIN=16
    -D TILT_MOVEMENT_SPEED=20
    -D TILT_DIRECTION_X=0
    -D TILT_DIRECTION_Y=1
    
    ; Button configuration
    -D BUTTON_HOME_PIN=33
    -D BUTTON_BACK_PIN=25
    -D BUTTON_DEBOUNCE_MS=50
    -D BUTTON_LONG_PRESS_MS=700
    -D BUTTON_DOUBLE_PRESS_MS=300
    
    ; Battery monitoring (optional)
    -D BATTERY_PIN=36
    -D ADC_MULTIPLIER=2.0
    -D BATTERY_SENSE_SAMPLES=10
    
    ; LED
    -D LED_PIN=2
    -D LED_INVERTED=false
    
    ; Include variant header
    -I variants/translator_partner

; Source files
src_filter = 
    +<*>
    -<.git/>
    -<.svn/>

; Libraries (only include if needed)
lib_deps = 
    ${env.lib_deps}
    ; RadioLib for LoRa (optional - only if using LoRa)
    ; jgromes/RadioLib @ ^6.4.0

upload_speed = 921600
upload_port = /dev/ttyUSB0  ; Change to your port

; ============================================================================
; Development Build (more logging)
; ============================================================================

[env:translator-partner-debug]
extends = env:translator-partner

build_flags = 
    ${env:translator-partner.build_flags}
    -D CORE_DEBUG_LEVEL=5
    -D DEBUG_JOYSTICK=1
    -D DEBUG_USB_SERIAL=1

; ============================================================================
; Production Build (optimized)
; ============================================================================

[env:translator-partner-release]
extends = env:translator-partner

build_flags = 
    ${env:translator-partner.build_flags}
    -D CORE_DEBUG_LEVEL=1
    -Os  ; Optimize for size

build_type = release

; ============================================================================
; Development Build (more logging)
; ============================================================================

[env:translator-partner-debug]
extends = env:translator-partner

build_flags = 
    ${env:translator-partner.build_flags}
    -D CORE_DEBUG_LEVEL=5
    -D DEBUG_JOYSTICK=1
    -D DEBUG_BLE_BRIDGE=1

; ============================================================================
; Production Build (optimized)
; ============================================================================

[env:translator-partner-release]
extends = env:translator-partner

build_flags = 
    ${env:translator-partner.build_flags}
    -D CORE_DEBUG_LEVEL=1
    -O2

build_type = release

